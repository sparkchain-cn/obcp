<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>添加企业用户</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" href="/admin/layui/css/layui.css" media="all" />
<link rel="stylesheet" href="/admin/css/main.css" media="all" />
<link rel="stylesheet" href="/admin/css/userForm.css" media="all" />
<link rel="stylesheet" href="/admin/css/company.css" media="all" />

<script type="text/javascript" src="/admin/layui/layui.js"></script>
<script type="text/javascript" src="/js/main.js"></script>
<script type="text/javascript" src="/js/user/util.js"></script>
</head>

<body class="childrenBody layui-bg-gray">
	<div class="layui-fluid layui-bg-white">

		<div class="layui-container">
			<!-- <h4 class="useredit-title">用户信息修改</h4> -->
			<div class="layui-row">
				<form class="layui-form" action="">
					<input type="hidden" name=id>
					<div class="layui-form-item">
						<label class="layui-form-label layui-form-title">企业信息</label>
						<hr style="height:1px;border:none;border-top:1px;" />				
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*企业名称：</label>
						<div class="layui-input-block">
							<input type="text" name="companyname"  id = "企业名称"
								lay-verify="required|username" placeholder="请输入企业名称"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*企业税号：</label>
						<div class="layui-input-block">
							<input type="text" name="taxid"
								lay-verify="required" placeholder="请输入企业税号" autocomplete="off"
								class="layui-input">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*法人姓名：</label>
						<div class="layui-input-block">
							<input type="text" name="corporationname" style="max-width: 600px" id="法人姓名"
								lay-verify="required|username" placeholder="请输入法人姓名" 
								autocomplete="off" class="layui-input checkUserFile">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*法人身份证号：</label>
						<div class="layui-input-block">
							<input type="text" name="corporationcardnum"
								lay-verify="required|identity" placeholder="请输入法人身份证号"
								autocomplete="off" class="layui-input checkUserFile">
						</div>
					</div>
					<div class="layui-form-item passwordItem" >
						<label class="layui-form-label">*登录密码：</label>
						<div class="layui-input-block">
							<input type="password" name="password"
								lay-verify="required|pass" placeholder="请输入登录密码"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item passwordItem">
						<label class="layui-form-label">*确认密码：</label>
						<div class="layui-input-block">
							<input type="password" name="confirmPassword"
								lay-verify="required|confirmPassword" placeholder="请再次输入登录密码"
								autocomplete="off" class="layui-input">
						</div>
					</div>
			
					<div class="layui-form-item">
						<label class="layui-form-label">*用户类型：</label>
						<div class="layui-input-block">
					      <input type="radio" name="vip" value="0" title="收费用户" >
					      <input type="radio" name="vip" value="1" title="免费用户">					
					    </div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*加盖公章营业执照：</label>
						<div class="layui-upload layui-upload-idcard">
						  <div class="layui-upload-list">
						    <img class="layui-upload-img" src='/admin/images/Artboard_03.jpg' id="businesslicensefile">
						    <p id="idcardText">点击上传</p>
						    <input type="hidden" name="businesslicensefile" >
						    </div>
						</div> 
					</div> 
					<!-- 联系人 -->
					<div class="layui-form-item">
						<label class="layui-form-label layui-form-title">联系人</label>
						<hr style="height:1px;border:none;border-top:1px;" />				
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*姓名：</label>
						<div class="layui-input-block">
							<input type="text" name="nickname" style="max-width: 600px" id="联系人姓名"
								lay-verify="required|username" placeholder="请输入联系人姓名"
								autocomplete="off" class="layui-input checkUserFile">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*电话：</label>
						<div class="layui-input-block">
							<input type="text" name="mobile" style="max-width: 600px"
								lay-verify="required|phone" placeholder="请输入联系人电话"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*身份证号：</label>
						<div class="layui-input-block">
							<input type="text" name="cardnum" style="max-width: 600px"
								lay-verify="required|identity" placeholder="请输入联系人身份证号"
								autocomplete="off" class="layui-input checkUserFile">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">*身份证照：</label>
						<div class="layui-upload layui-upload-idcard">
						  <div class="layui-upload-list">
						    <img class="layui-upload-img" src='/admin/images/Artboard_03.jpg' id="idcard">
						    <p id="idcardText">点击上传</p>
						    <input type="hidden" name="cardnumFrontFile" >
						    </div>
						    <div class="layui-upload-list">
						    <img class="layui-upload-img" src='/admin/images/Artboard_05.jpg' id="idcardBack">
						     <p id="idcardBackText">点击上传</p>
						     <input type="hidden" name="cardnumBackFile">
						  </div>
						</div> 
						</div>  		
						<div class="layui-form-item verifyFile" style="display:none">
							<label class="layui-form-label">*授权证明：</label>
							<div class="layui-upload layui-upload-idcard">
							  <div class="layui-upload-list">
							    <img class="layui-upload-img" src='/admin/images/Artboard_03.jpg' id="authfile">
							    <p id="idcardText">点击上传</p>
							    <input type="hidden" name="authfile" >
							    </div>
							</div> 
						</div> 
			<!-- 	
					<div class="layui-form-item verifyFile" style="display:none">
							<label class="layui-form-label">授权证明</label>
							<hr style="height:1px;border:none;border-top:1px;" />				
						</div>
					<div class="layui-form-item verifyFile" style="display:none">
								autocomplete="off" class="layui-input">
								<input type="hidden" name="authfile"> 
						  	<div class="layui-upload">
							   <button type="button" class="layui-btn" id="uploadFile">上传</button>
							</div>
						</div> 
					</div>   -->		
					<div class="layui-form-item">
						<div class="layui-input-block">
							<button class="layui-btn" lay-submit="" lay-filter="formDemo">立即提交</button>
							<!-- <button id="reset" type="reset"
								class="layui-btn layui-btn-primary">重置</button> -->
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</body>

<script>
		layui.use(['form', "upload", "jquery",'layer','element'], function() {
			var form = layui.form,
				upload = layui.upload,
				layer = layui.layer,
				element = layui.element,
				$ = layui.jquery,id="${userId}",
				uploadPath = "${uploadPath}",downPath="${downPath}",sameFlg=true;
				
			  if(id){
				$("#reset").remove();
				$(".passwordItem").remove();
				$.post("/v1/userextend/getInfo", {id:id}, function(data) {
					if(data && data.code == 200){
						var user = data.data || {};
						$.each(user,function(i,value){
							if(value && i != "vip"){
								$("input[name="+i+"]").val(value);	
							}else if(i == "vip"){
								$("input[name="+i+"][value='"+user.vip+"']").attr("checked",true);
							}
						});
						$("[name=mobile]").attr("readonly","readonly");
					 	$("[name=confirmPassword]").val(user.password);
					 	if(user.cardnumFrontFile)
					 		$("#idcard").attr("src",downPath + "&id="+user.cardnumFrontFile);
					 	if(user.cardnumBackFile)
							$("#idcardBack").attr("src",downPath + "&id="+user.cardnumBackFile);
					 	if(user.businesslicensefile)
							$("#businesslicensefile").attr("src",downPath + "&id="+user.businesslicensefile);
					
						$("#officeAddr").val(user.officeAddr);
						if(user.organization == 1 && user.authfile){
							$('.verifyFile').show();
							$("#authfile").attr("src",downPath + "&id="+user.authfile);
						}
						//身份证号码不能修改
						$("[name=corporationcardnum]").attr("readonly",true);
						$("[name=cardnum]").attr("readonly",true);
						
					}
					form.render();
					//		            }
				});
			}
			
			form.verify({
				 email:function(value, item){
					if(value){
						if(!new RegExp("^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$").test(value)){
					      return '邮箱格式不正确';
					    }
					}
				 },
				 identity:function(value,item){
				 	 /* if(value){
						 if(!new RegExp("(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)").test(value)){
						      return '身份证号格式不正确';
						    }
					 }  */
				 },
				 confirmPassword:function(value,item){
					 var passwordText = $("[name=password]").val();
		
					 if(value != passwordText){
						 return "两次输入密码不一致";
					 }
				 },
				 username: function(value, item){ //value：表单的值、item：表单的DOM对象					 
					if(value){
						
					    if(!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)){
						      return item.id + '不能有特殊字符';
						    }
					    else if(/(^\_)|(\__)|(\_+$)/.test(value)){
						      return item.id + '首尾不能出现下划线\'_\'';
						    }
					    else  if(/^\d+\d+\d$/.test(value)){
						      return item.id + '不能全为数字';
						    }
					    else if(value.length > 20){
					    	return item.id + '不能超过20个字';
					    }
					 }
				  },
				  maxlen:function(value,item){
					  if(value){
						  if(value.length > 50){
							  return '长度不能超过60个字';
						  }
					  }
				  }
				  //我们既支持上述函数式的方式，也支持下述数组的形式
				  //数组的两个值分别代表：[正则匹配、匹配不符时的提示文字]
				  ,pass: function(value,item){
					/*   if(!$("input[name=id]").val()){
						  var reg=new RegExp(/^(?=.*?[a-z])(?=.*?[A-Z])(?=.*?\d)(?=.*?[0-9])[a-zA-Z\d#@*&.]*$/);							
						  if(!reg.test(value)){
							  return "请输入6-18位，且包含大小写英文字母和数字";
						  }		
					  }
					 */
		              if (value === "")
		                  return "密码不能为空！";
		               var reg = new RegExp(/^(\w){6,18}$/);				  
					   var numPatrn=new RegExp(/^[0-9]{1,20}$/);
					   if(numPatrn.test(value)){
				 		  return "密码不能为全为数字";
				        }
					   else if(!reg.test(value)){
					 	  return "请输入6-18位，字母，数字或下滑线";
					   }	
				  }
			});

			//各种基于事件的操作，下面会有进一步介绍
			form.on('submit(formDemo)', function(data) {
				//var sex = $("input[name=sex]:checked").attr("value");
				//var loading = layer.load(1);
				var user = data.field;
				
				var url = "/v1/userextend/companyAdd"
				//user.sex = sex;
				if(user.id){
				  url = "/v1/userextend/companyUpdate"
				}
				if(!sameFlg&&!user.authfile){ //不同					
					layer.msg("授权证明文件不能为空",{icon:5});
					return false;					
				}
				user.vip = $("input[name=vip]:checked").val();
	 			$.post(url,user,function(response){
					//layer.close(loading);				
					if(response){
						if(response.code == 200){
						 	layer.msg("保存成功！", {
					            icon: 6,
					            time: 1000
					          }, function() {
					            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
					            parent.layer.close(index); //再执行关闭
					          }); 
						}else{
							layer.msg(response.message, {
					            icon: 5,
					            time: 2000
					          });
						 }
					}else{
						layer.msg("返回错误", {
				            icon: 5,
				            time: 2000
				          });
					}
				}).error(function(r,s,t){
					layer.msg("服务端异常！",{icon:5});
				}); 

				return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
			});
			
			//判断是否是需要上传授权证明
			$(".checkUserFile").on("blur",function(){
				var corporationname = $("[name=corporationname]").val();
				var corporationcardnum = $("[name=corporationcardnum]").val();
				var nickname = $("[name=nickname]").val();
				var cardnum = $("[name=cardnum]").val();
				if(corporationname && corporationcardnum && nickname && cardnum){ //四个都有输入值
					 if(corporationname != nickname || corporationcardnum != cardnum ){
						 $(".verifyFile").show();				
						 sameFlg = false;
						// $(".verifyFile").attr("lay-verify","require")
					 }else{
						 $(".verifyFile").hide();
						 sameFlg = true;
						 //$(".verifyFile").attr("lay-verify","")
					 }
					// form.render();
				 }
			});
			
			// 上传身份证			
			//正面
			  var uploadIdcard = upload.render({
			    elem: '#idcard'
			    ,url: uploadPath
			    ,accept:'images'
			    ,acceptMime:'image/*'
			    ,before: function(obj){
			      //预读本地文件示例，不支持ie8
			    /*   obj.preview(function(index, file, result){
			        $('#idcard').attr('src', result); //图片链接（base64）
			      }); */
			    }
			    ,done: function(res){
			      //如果上传失败
			      if(!res.success){
			        return layer.msg('上传失败');
			      }else{
			    	  $("#idcard").attr("src",downPath + "&id="+res.data);
			    	  $("[name=cardnumFrontFile]").val(res.data);
			      }
			      //上传成功
			    }
			    ,error: function(){
			      //演示失败状态，并实现重传
			      var demoText = $('#idcardText');
			      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
			      demoText.find('.demo-reload').on('click', function(){
			        uploadInst.upload();
			      });
			    }
			  });
			
			//背面
			  var uploadIdcardBack = upload.render({
			    elem: '#idcardBack'
			    ,url: uploadPath
			    ,accept:'images'
			    ,acceptMime:'image/*'
			    ,before: function(obj){
			      //预读本地文件示例，不支持ie8
			     /*  obj.preview(function(index, file, result){
			        $('#idcardBack').attr('src', result); //图片链接（base64）
			      }); */
			    }
			    ,done: function(res){
			      //如果上传失败
		    	 if(!res.success){
			        return layer.msg('上传失败');
			      }else{
			    	  $("#idcardBack").attr("src",downPath + "&id="+res.data);
			    	  $("[name=cardnumBackFile]").val(res.data);
			    	  
			      }
			      //上传成功
			    }
			    ,error: function(){
			      //演示失败状态，并实现重传
			      var demoText = $('#idcardBackText');
			      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
			      demoText.find('.demo-reload').on('click', function(){
			        uploadInst.upload();
			      });
			    }
			  });
			
			
			//营业执照
			 var uploadIdcardHead = upload.render({
			    elem: '#businesslicensefile'
			    ,url: uploadPath
			    ,accept:'images'
			    ,acceptMime:'image/*'
			    ,before: function(obj){
			      //预读本地文件示例，不支持ie8
			 /*      obj.preview(function(index, file, result){
			        $('#headIdCard').attr('src', result); //图片链接（base64）
			      }); */
			    }
			    ,done: function(res){
			      //如果上传失败
		    	 if(!res.success){
			        return layer.msg('上传失败');
			      }else{
			    	  $("#businesslicensefile").attr("src",downPath + "&id="+res.data);
			    	  $("[name=businesslicensefile]").val(res.data);
			      }
			      //上传成功
			    }
			    ,error: function(){
			      //演示失败状态，并实现重传
			      var demoText = $('#headIdCardText');
			      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
			      demoText.find('.demo-reload').on('click', function(){
			        uploadInst.upload();
			      });
			    }
			  });


			 var uploadIdcardHead = upload.render({
			    elem: '#authfile'
			    ,url: uploadPath
			    ,accept:'images'
			    ,acceptMime:'image/*'
			    ,before: function(obj){
			      //预读本地文件示例，不支持ie8
			 /*      obj.preview(function(index, file, result){
			        $('#headIdCard').attr('src', result); //图片链接（base64）
			      }); */
			    }
			 ,choose: function(obj){
				    //将每次选择的文件追加到文件队列
				    var files = obj.pushFile();
				    
				    //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
				  /*   obj.preview(function(index, file, result){
				      $("[name=fileName]").val(file.name);
				    }); */
				  }
			    ,done: function(res, index, upload){
			      //如果上传失败
		    	 if(!res.success){
			        return layer.msg('上传失败');
			      }else{
			    	  $("#authfile").attr("src",downPath + "&id="+res.data);
			    	  $("[name=authfile]").val(res.data);
			      }
			      //上传成功
			    }
			    ,error: function(){
			      //演示失败状态，并实现重传
			      var demoText = $('#headIdCardText');
			      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
			      demoText.find('.demo-reload').on('click', function(){
			        uploadInst.upload();
			      });
			    }
			  });
			 
			//查看示例
			layer.photos({
			  photos: '#demo-Idcard'
			}); 
		});
	</script>
</html>